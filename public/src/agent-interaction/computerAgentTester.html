<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="agentTester.css" type="text/css" rel="stylesheet">
    <title></title>
</head>
<body>
<script src="../../lib/js/socket.io.js"></script>
<script src="../../lib/js/jquery-1.8.2.js"></script>
<script src="agentAPI.js"></script>

<form>
    <input type="button" value="Delete Cookies" onclick=deleteAllCookies()>
</form>

<form id = "serverIpForm" >
    Agent name: <input type = "text" id = "agentName" name="agentName" value = "HAL">
    Server IP: <input type = "text" id = "serverIp" name="serverIp" >
    <!--<input type="button" value="Submit" onclick=createAgent()>-->
    <!--<script> createAgent()</script>-->
    <!--<script href="javascript:createAgent();"></script>-->

</form>

<div id = agentOperations>
<br>
<br>
<form>
    Pos x : <input type = "number" id = "posX" name="posX" value = 200>
    Pos y : <input type = "number" id = "posY" name="posY" value = 200>
    Sbgnclass: <input type = "text" id = "sbgnclass" name="sbgnclass" value = "macromolecule">
    <input type="button" value="Add node" onclick=addNode()>
</form>
<br>
<form>
    Id : <input id = "delNodeId"  >
    <input type="button" value="Delete node" onclick=deleteNode()>
</form>
    <br>
    <form>
        Id : <input id = "moveNodeId">
        Pos x : <input type = "number" id = "newPosX">
        Pos y : <input type = "number" id = "newPosY">
        <input type="button" value="Move node" onclick=moveNode()>
    </form>

<br>
    <button id = "updateModel" onclick = updateModel()>Update model</button>
</div>


<div id = modelHistory>
<ul id = 'operationHistory'  as="container" onchange = scrollToBottom('operationHistory')><b>Commands<br></b></ul>
<ul id = 'chat' as="container"><b>Chat Messages<br></b></ul>
<ul id = 'userList' as="container"><b>Online Users<br></b></ul>
</div>

</body>


<script>

    function scrollToBottom(docId){
        console.log("here");
        document.getElementById(docId).scrollTop = document.getElementById(docId).scrollHeight;
    }
    $('#operationHistory').bind('DOMSubtreeModified', function(){
        scrollToBottom('operationHistory');
    });


    var agent;


    window.onload = function (){
        createAgent();
    }

    $('#serverIp').change(function(){
        deleteCookie('docId'); //delete previous cookie

        //add the new cookie
        serverIp = $('#serverIp')[0].value;  //change cookie
        document.cookie = 'docId=' +  serverIp;  //add cookie docId

        createAgent();
    });


    function generateHash(len) {
        var symbols = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
        var hash = '';
        for (var i = 0; i < len; i++) {
            var symIndex = Math.floor(Math.random() * symbols.length);
            hash += symbols.charAt(symIndex);
        }
        return hash;
    }
    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
    }

    var deleteCookie = function(cname) {
        document.cookie = cname + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    };

    var deleteAllCookies = function(){
        deleteCookie('userId'); //delete previous cookie
        deleteCookie('docId'); //delete previous cookie

    };

    function createAgent(){


        //don't open a new socket unless it is a new agent
        var agentId = getCookie('userId');

        if(agentId == null || agentId == ''){
            agentId = generateHash(32);
            document.cookie = 'userId=' +  agentId;  //add cookie docId
        }

        var serverIp = getCookie('docId')

        if(serverIp == null){
            serverIp = $('#serverIp')[0].value;
            document.cookie = 'docId=' +  serverIp;  //add cookie docId
        }
        else{
            $('#serverIp')[0].value = serverIp;
        }

        agent = new Agent($('#agentName')[0].value, agentId);
        var socket = agent.connectToServer(serverIp);


        socket.on('connect', function(){
            agent.getModel(function() {
                agent.updateNextAgentNodeId();
                agent.getOperationHistory(function(){
                    agent.getChatHistory(function(){
                        agent.getUserList(function(){
                            agent.updateWebPage();
                        });
                    });
                });
            });

            agent.listen();

        });
    }

    function updateModel(){
        agent.getModel();
    }

    function addNode(){
        var x = $('#posX')[0].value;
        var y = $('#posY')[0].value;
        var sbgnclass = $('#sbgnclass')[0].value;
        var param = {x:x, y:y, sbgnclass:sbgnclass }

        agent.sendRequest("agentAddNodeRequest", {id: agent.getNextNodeId(), param:param});

    }


    function deleteNode(){
        agent.sendRequest("agentDeleteNodeRequest", {id: $('#delNodeId')[0].value});
    }

    function moveNode(){
        var x = $('#newPosX')[0].value;
        var y = $('#newPosY')[0].value;
        var id = $('#moveNodeId')[0].value;
        var pos = {x:x, y:y}
        agent.sendRequest("agentMoveNodeRequest", {id: id, pos:pos});

    }





</script>

</html>