<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="agentTester.css" type="text/css" rel="stylesheet">
    <title></title>
</head>
<body>
<script src="../../lib/js/socket.io.js"></script>
<script src="../../lib/js/jquery-1.8.2.js"></script>
<script src="agentAPI.js"></script>


<form id = "serverIpForm" >
    Agent name: <input type = "text" id = "agentName" name="agentName" value = "HAL">
    Server IP: <input type = "text" id = "serverIp" name="serverIp" >
    <!--<input type="button" value="Submit" onclick=createAgent()>-->
    <!--<script> createAgent()</script>-->
    <!--<script href="javascript:createAgent();"></script>-->

</form>

<div id = agentOperations>
<br>
<br>
<form>
    Pos x : <input type = "number" id = "posX" name="posX" value = 10>
    Pos y : <input type = "number" id = "posY" name="posY" value = 10>
    Sbgnclass: <input type = "text" id = "sbgnclass" name="sbgnclass" value = "macromolecule">
    <input type="button" value="Add node" onclick=addNode()>
</form>
<br>
<form>
    Id : <input id = "nodeId" name="nodeId" >
    <input type="button" value="Delete node" onclick=deleteNode()>
</form>

</div>

<ul id = 'operationHistory'><b>Commands<br></b></ul>
<ul id = 'chat'><b>Chat Messages<br></b></ul>
<ul id = 'userList'><b>Online Users<br></b></ul>

</body>


<script>

    window.onload = function (){
        createAgent();
    }

    $('#serverIp').change(function(){
        deleteCookie('docId'); //delete previous cookie
        //add the new cookie
        serverIp = $('#serverIp')[0].value;  //change cookie
        document.cookie = 'docId=' +  serverIp;  //add cookie docId

        createAgent();
    });

    var agent;
    var newNodeId = 0;
    function generateHash(len) {
        var symbols = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
        var hash = '';
        for (var i = 0; i < len; i++) {
            var symIndex = Math.floor(Math.random() * symbols.length);
            hash += symbols.charAt(symIndex);
        }
        return hash;
    }
    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
    }

    var deleteCookie = function(cname) {
        document.cookie = cname + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    };
    function createAgent(){


        //don't open a new socket unless it is a new agent
        var agentId = getCookie('userId');
        if(agentId == null){
            agentId = generateHash(32);
            document.cookie = 'userId=' +  agentId;  //add cookie docId
        }

        var serverIp = getCookie('docId')

        if(serverIp == null){
            serverIp = $('#serverIp')[0].value;
            document.cookie = 'docId=' +  serverIp;  //add cookie docId
        }
        else{
            $('#serverIp')[0].value = serverIp;
        }

        agent = new Agent($('#agentName')[0].value, document.cookie);
        var socket = agent.connectToServer(serverIp);


        socket.on('connect', function(){
            agent.getModel();


            agent.getOperationHistory();
            agent.getChatHistory();
            agent.getUserList();

            setTimeout(function(){ //wait for the history to load
                agent.updateWebPage(); }, 1000);


            agent.listen();

        });
    }

    function addNode(){
        var x = $('#posX')[0].value;
        var y = $('#posY')[0].value;
        var sbgnclass = $('#sbgnclass')[0].value;
        var id = "" + newNodeId++;
        agent.addNode(id,x,y,sbgnclass);
    }

    function deleteNode(){
        agent.deleteNode($('#nodeId')[0].value);
    }



</script>

</html>