<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="agentTester.css" type="text/css" rel="stylesheet">
    <title></title>
</head>
<body>
<script src="../../lib/js/socket.io.js"></script>
<script src="../../lib/js/jquery-1.8.2.js"></script>
<script src="agentAPI.js"></script>

<form>
    <input type="button" value="Delete Cookies" onclick=deleteAllCookies()>
</form>

<form id = "serverIpForm" >
    Agent name: <input type = "text" id = "agentName" name="agentName" value = "HAL">
    Server IP: <input type = "text" id = "serverIp" name="serverIp" >
    <!--<input type="button" value="Submit" onclick=createAgent()>-->
    <!--<script> createAgent()</script>-->
    <!--<script href="javascript:createAgent();"></script>-->

</form>

<div id = agentOperations>
<br>
<br>
    <button id = "updateModel" onclick = updateModel()>Model update request</button>
    <br>
    <br>

    <form id = "nodeOperations">

        Pos x : <input type = "number" id = "posX" name="posX" value = 200>
        Pos y : <input type = "number" id = "posY" name="posY" value = 200>
        Sbgnclass: <input type = "text" id = "sbgnclass" name="sbgnclass" value = "macromolecule">
        <input type="button" value="Add node" onclick=addNode()>

        <br><br>
        <b>Node Id </b>: <select name="Id" id = "nodeId" >
        </select>

        <br><br>
        <input id = "sbgnlabel">
        <input type="button" value="Update node label" onclick=changeNodeAttribute("sbgnlabel")>


        <br><br>
        <input type="button" value="Delete node" onclick=deleteNode()>
        <br> <br>
        Pos x : <input type = "number" id = "newPosX">
        Pos y : <input type = "number" id = "newPosY">
        <input type="button" value="Move node" onclick=moveNode()>

        <br><br>

        <input id = "width" type = "number">
        <input type="button" value="Update node width" onclick=changeNodeAttribute("width")>


        <input id = "height" type = "number">
        <input type="button" value="Update node height" onclick=changeNodeAttribute("height")>


        <br><br>
        <input id = "borderColor" type = "color">
        <input type="button" value="Update border color" onclick=changeNodeAttribute("borderColor")>

        <br><br>
        <input id = "backgroundColor" type = "color">
        <input type="button" value="Update background color" onclick=changeNodeAttribute("backgroundColor")>

        <br><br>
        <input id = "borderWidth">
        <input type="button" value="Update border width" onclick=changeNodeAttribute("borderWidth")>


        <br><br>
        Update clone marker status <input id = "isCloneMarker" type="checkbox"  onclick=changeNodeAttribute("isCloneMarker")>

        <br><br>
        Update multimer status <input id = "isMultimer" type="checkbox"  onclick=changeNodeAttribute("isMultimer")>

        <br><br>
        <table>
        <tr style='border: 1px solid #dddddd;'><td style='width: 100px'> State Variables </td><td id='stateVariables'style='width: 10px'></td></tr>

        <br><br>
        <tr style='border: 1px solid #dddddd;'><td style='width: 100px'> Unit Of Information</td><td id='unitsOfInformation' style='width: 10px'></td></tr>
        </table>
        <!--<br><br>-->
            <!--<input id = "stateVariablesValue">-->
         <!--<input type = button  value = "Update state variable value" onclick=changeNodeAttribute("stateVariablesValue")>-->
            <!--<br><br>-->
            <!--<input id = "stateVariablesVariable"> <input type = "button"  value = "Update state variable name"  onclick=changeNodeAttribute("stateVariablesVariable")>-->
        <!--<br><br>-->
        <!--<input id = "stateVariablesUnitOfInformation" >-->
            <!--<input type = "button" value = "Update unit of information" onclick=changeNodeAttribute("stateVariablesUnitOfInformation")>-->

    </form>
<br><br>

    <!-- Edge operations-->
    <form id = "edgeOperations">
        Source : <input  id = "source" name="source" value = "glyph2">
        Target : <input  id = "target" name="target" value = "glyph8" >
        Sbgnclass: <input id = "sbgnclassEdge" name = "sbgnclassEdge" value = "consumption">
        <input type="button" value="Add edge" onclick=addEdge()>

        <br><br>

        <b>Edge Id </b>: <select name="Id" id = "edgeId" ></select>
        <br><br>
        <input type="button" value="Delete edge" onclick=deleteEdge()>

        <br><br>
        <input id = "cardinality" type = number>
        <input type="button" value="Update edge cardinality" onclick=changeEdgeAttribute("cardinality")>

        <br><br>
        <input id = "widthEdge">
        <input type="button" value="Update edge width" onclick=changeEdgeAttribute("widthEdge")>


        <br><br>
        <input id = "lineColor" type = color>
        <input type="button" value="Update edge color" onclick=changeEdgeAttribute("lineColor")>

</form>
</div>


<div id = modelHistory>
<ul id = 'operationHistory'  as="container" onchange = scrollToBottom('operationHistory')><b>Commands<br></b></ul>
<ul id = 'chat' as="container" onchange = scrollToBottom('chat')><b>Chat Messages<br></b></ul>
<ul id = 'userList' as="container" onchange = scrollToBottom('userList')><b>Online Users<br></b></ul>
    <div id = "receivedImage"  onclick =openImage() ></div>
</div>


</body>


<script>

    var agent;


    window.onload = function () {
        createAgent();


        $('#agentName').change(function () {
            agent.changeName($('#agentName')[0].value);


        });

        $('#operationHistory').bind('contentchanged', function () {
            scrollToBottom('operationHistory');
        });

        $('#chat').bind('contentchanged', function () {
            scrollToBottom('chat');

        });

        $('#serverIp').change(function () {
            deleteCookie('docId'); //delete previous cookie

            //add the new cookie
            serverIp = $('#serverIp')[0].value;  //change cookie
            document.cookie = 'docId=' + serverIp;  //add cookie docId

            createAgent();
        });

        $('#nodeId').change(function () {

            //update node info
            agent.getNodeRequest($('#nodeId')[0].value, function () {

                $('#newPosX')[0].value = preciseRound(agent.selectedNode.position.x, 3);
                $('#newPosY')[0].value = preciseRound(agent.selectedNode.position.y, 3);
                $('#width')[0].value = preciseRound(agent.selectedNode.width, 3);
                $('#height')[0].value = preciseRound(agent.selectedNode.height, 3);
                $('#borderWidth')[0].value = agent.selectedNode.borderWidth;
                $('#borderColor')[0].value = agent.selectedNode.borderColor;
                $('#backgroundColor')[0].value = agent.selectedNode.backgroundColor;
                $('#sbgnlabel')[0].value = agent.selectedNode.sbgnlabel;


                if (agent.selectedNode.isCloneMarker)
                    $('#isCloneMarker').attr('checked', 'checked');
                else
                    $('#isCloneMarker').attr('checked', false);


                if (agent.selectedNode.isMultimer)
                    $('#isMultimer').attr('checked', 'checked');
                else
                    $('#isMultimer').attr('checked', false);


                fillInspectorStateAndInfos(agent.selectedNode);
            });
        });


        $('#edgeId').change(function () {
            //update node info
            agent.getEdgeRequest($('#edgeId')[0].value, function () {
                $('#cardinality')[0].value = agent.selectedEdge.cardinality;
                $('#lineColor')[0].value = agent.selectedEdge.lineColor;
                $('#widthEdge')[0].value = agent.selectedEdge.width;
            });
        });
    };


    function createAgent(){

        //don't open a new socket unless it is a new agent
        var agentId = getCookie('userId');

        if(agentId == null || agentId == ''){
            agentId = generateHash(32);
            document.cookie = 'userId=' +  agentId;  //add cookie docId
        }

        var serverIp = getCookie('docId')

        if(serverIp == null){
            serverIp = $('#serverIp')[0].value;
            document.cookie = 'docId=' +  serverIp;  //add cookie docId
        }
        else{
            $('#serverIp')[0].value = serverIp;
        }

        agent = new Agent($('#agentName')[0].value, agentId);
        var socket = agent.connectToServer(serverIp, function(){
            writeUserList(agent.userList);
        });



        socket.on('connect', function(){


            agent.getModel(function() {

                agent.updateNextAgentNodeId();
                agent.getOperationHistory(function(){

                    agent.getChatHistory(function(){
                            //Write history
                        if(agent.opHistory != null){
                            agent.opHistory.forEach(function(op){
                                writeCommand(op);
                            });
                        }

                        if(agent.chatHistory != null){
                            for(var ind in agent.chatHistory){
                                writeMessage(agent.chatHistory[ind]);

                            };
                        }

                        fillNodeIds('nodeId');
                        fillEdgeIds('edgeId');

                    });
                });
            });

            agent.listen(function(){

                socket.on('operation', function(data){
                    writeCommand(data);

                });
                socket.on('message', function(data){
                    writeMessage(data);
                });

                socket.on('userList', function(data){
                    writeUserList(data);
                });

                socket.on('imageFile', function(data){
                    writeImage(data);
                });

            });

        });
    }


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Agent requests and operations
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function updateModel(callback){
        agent.getModel(callback);

    };

    function addNode(){
        var x = $('#posX')[0].value;
        var y = $('#posY')[0].value;
        var sbgnclass = $('#sbgnclass')[0].value;
        var param = {x:x, y:y, sbgnclass:sbgnclass }

        agent.sendRequest("agentAddNodeRequest", {id: agent.getNextNodeId(), param:param});

    }

    function addEdge(){

        var source = $('#source')[0].value;
        var target = $('#target')[0].value;
        var sbgnclass = $('#sbgnclassEdge')[0].value;
        var param = {source:source, target:target, sbgnclass:sbgnclass }

        agent.sendRequest("agentAddEdgeRequest", {id: (source+ "-" + target), param:param});

    }

    function deleteNode(){
        agent.sendRequest("agentDeleteNodeRequest", {id: $('#nodeId')[0].value});
    }
    function deleteEdge(){
        agent.sendRequest("agentDeleteEdgeRequest", {id: $('#edgeId')[0].value});
    }

    function moveNode(){
        var id = $('#nodeId')[0].value;
        var x = $('#newPosX')[0].value;
        var y = $('#newPosY')[0].value;



        var pos = {x:x, y:y};

        agent.sendRequest("agentMoveNodeRequest", {id: id, pos:pos});

    }

    function changeNodeAttribute(attDiv){


        var val;
        var id = $('#nodeId')[0].value;
        var attStr = attDiv;
        agent.getNodeRequest(id, function () {
            if (attDiv == 'isCloneMarker')
                val = ($('#isCloneMarker').attr('checked') == 'checked');

            else if (attDiv == 'isMultimer')
                val = ($('#isMultimer').attr('checked') == 'checked');

            else
                val = $('#' + attDiv)[0].value;

            agent.sendRequest("agentChangeNodeAttributeRequest", {id: id, attStr: attStr, attVal: val});
        });
    }



    function changeUnitOfInformation(oldLabelText){
        var id = $('#nodeId')[0].value;

        agent.getNodeRequest(id, function () {
            var states = agent.selectedNode.sbgnStatesAndInfos;

            //find which state this corresponds to
            states.forEach(function (s) {
                if (s.clazz == 'unit of information') {
                    if (s.label.text == oldLabelText)
                        s.label.text = $('.unitOfInformationLabel')[0].value;
                }
            });
            agent.sendRequest("agentChangeNodeAttributeRequest", {
                id: id,
                attStr: "sbgnStatesAndInfos",
                attVal: states
            });
        });

    }

    function changeStateVariable(oldStateVariable, oldStateValue){
        var id = $('#nodeId')[0].value;

        agent.getNodeRequest(id, function () {
            var states = agent.selectedNode.sbgnStatesAndInfos;


            //find which state this corresponds to
            states.forEach(function (s) {
                if (s.clazz == 'state variable') {
                    if (s.state.value == oldStateValue && s.state.variable == oldStateVariable) {
                        s.state.value = $('.stateVariableValue')[0].value;
                        s.state.variable = $('.stateVariableVariable')[0].value;
                    }
                }
            });
            agent.sendRequest("agentChangeNodeAttributeRequest", {
                id: id,
                attStr: "sbgnStatesAndInfos",
                attVal: states
            });
        });

    }


    function changeEdgeAttribute(attDiv){
        var val;
        var id = $('#edgeId')[0].value;
        var attStr = attDiv;

        val = $('#' + attDiv)[0].value;

        if(attDiv == "widthEdge") //same name with node
            attStr = "width";
        agent.sendRequest("agentChangeEdgeAttributeRequest", {id:id, attStr:attStr, attVal: val});


    }
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///Page editing
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function fillNodeIds(divId){
        $('#'+divId).empty();
        var nodeList = agent.getNodeList();

        var nodeNameList = [];

        var i = 0;
        for( var node in nodeList){
            nodeNameList[i++] = node;

        };
        nodeNameList.sort();
        nodeNameList.forEach(function(nodeName){
            $('#'+divId).append("<option value =\"" + nodeName + "\">" + nodeName + "</option>") ;
        });
    }

    function fillEdgeIds(divId){
        $('#'+divId).empty();
        var edgeList = agent.getEdgeList();

        var edgeNameList = [];

        var i = 0;
        for( var edge in edgeList){
            edgeNameList[i++] = edge;

        };
        edgeNameList.sort();
        edgeNameList.forEach(function(edgeName){
            $('#'+divId).append("<option value =\"" + edgeName + "\">" + edgeName + "</option>") ;
        });
    }

    function writeCommand(op){
        var command = "<b>" + op.userName + " (" + formatTime(op) + "): " + "</b>"  +op.name +  " " +op.id +  " " +JSON.stringify(op.param);
        $('#operationHistory').append("<li>" + command+ "</li>");

        $('#operationHistory').trigger('contentchanged');

    }

    function writeMessage(msg){
        var htmlMessage = "<b>" + msg.userName + " (" + formatTime(msg) + "): "+ "</b>"  +msg.comment ;
        $('#chat').append("<li>" + htmlMessage+ "</li>");
        $('#chat').trigger('contentchanged');
    }


    function writeUserList(userList){
        $('#userList').empty();
        $('#userList').append("<b> Online Users");


        if(userList!=null){
            userList.forEach(function(usr){
                $('#userList').append("<li>" + usr.userName+ "</li>");
            });
        }
    }

    function writeImage(data){


        $('#receivedImage').append('<img src="' + data + '"/>');

    }



    function generateHash(len) {
        var symbols = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
        var hash = '';
        for (var i = 0; i < len; i++) {
            var symIndex = Math.floor(Math.random() * symbols.length);
            hash += symbols.charAt(symIndex);
        }
        return hash;
    }
    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
    }

    var deleteCookie = function(cname) {
        document.cookie = cname + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    };

    var deleteAllCookies = function(){
        deleteCookie('userId'); //delete previous cookie
        deleteCookie('docId'); //delete previous cookie

    };


    function formatTime(message){
        var hours, minutes, seconds, period, time;
        time = message && message.time;
        if (!time) {
            return;
        }
        time = new Date(time);
        hours = time.getHours();

        minutes = time.getMinutes();

        seconds = time.getSeconds();

        if (minutes < 10) {
            minutes = '0' + minutes;
        }
        if (seconds < 10) {
            seconds = '0' + seconds;
        }
        return hours + ':' + minutes + ':' + seconds;
    }

    function preciseRound(num, decimals) {
        if(decimals == null) decimals = 3;
        var t=Math.pow(10, decimals);
        return (Math.round((num * t) + (decimals>0?1:0)*(Math.sign(num) * (10 / Math.pow(100, decimals)))) / t).toFixed(decimals);
    }

    function scrollToBottom(docId){
        document.getElementById(docId).scrollTop = document.getElementById(docId).scrollHeight;

    }
    function openImage(){
        var largeImage = $('#receivedImage')[0];
        if( $('#receivedImage img')[0] !=null) {
            var url = $('#receivedImage img')[0].src;
            window.open(url, 'Image', 'width=largeImage.stylewidth,height=largeImage.style.height,resizable=1');
        }
    }

    function timeoutCallback(timeout,callback) {
        var called = false;
        if (typeof timeout === 'function') {
            callback = timeout;
            timeout = 30 * 1000;
        }

        var interval = setTimeout(function () {
            if (called)return;
            called = true;
            callback(new Error('callback timeout'));
        }, timeout);

        return function () {
            if (called)return;
            called = true;
            clearTimeout(interval);
            callback.apply(this, arguments);
        }
    }


    function fillInspectorStateAndInfos(ele) {


        var width = 100;
        //first empty the state variables and infos data in inspector
        $("#stateVariables").html("");
        $("#unitsOfInformation").html("");
        var stateAndInfos = ele.sbgnStatesAndInfos;


        for(var si in stateAndInfos){

            var state = stateAndInfos[si];

            if (state.clazz == "state variable") {

                $("#stateVariables").append("<div><input type='text' style=\"width:40px\" class='justAddedStateVariablesInput stateVariableValue' value='"   + state.state.value + "'/>"

                        + "@<input type='text' style=\"width:40px\" class='justAddedStateVariablesInput stateVariableVariable'  + value='" + state.state.variable + "'/>"
                        + "<img style=\"width:12px;height:12px;\" class='justAddedStateVariablesInput deleteStateAndInfo' src='../../sample-app/sampleapp-images/delete.png'></div>");


                var oldStateVariable = state.state.variable;
                var oldStateValue = state.state.value;

                //Change variable
                $(".stateVariableVariable").unbind('change').on('change', function () {
                    changeStateVariable(oldStateVariable, oldStateValue);
                });


                //Change value
                $(".stateVariableValue").unbind('change').on('change', function () {
                    changeStateVariable(oldStateVariable, oldStateValue);
                });


            }
            else if (state.clazz == "unit of information") {

                //var total = width / 5 + width / 5 + width / 2.5;
                $("#unitsOfInformation").append("<div><input type='text' class='justAddedStateVariablesInput unitOfInformationLabel' value='" + state.label.text+ "'/>"
                        +"<img style=\"width:12px;height:12px;\" class='justAddedStateVariablesInput deleteStateAndInfo' src='../../sample-app/sampleapp-images/delete.png'></div>");

                var oldLabelText = state.label.text;
                $(".unitOfInformationLabel").unbind('change').on('change', function () {
                    changeUnitOfInformation(oldLabelText);
                });
            }

            $(".deleteStateAndInfo").unbind('click').click(function (event) {
                var param = {
                    obj: $(this).data("state"),
                    ele: ele,
                    width: width
                };
            //todo    editorActions.manager._do(editorActions.RemoveStateAndInfoCommand(param));
            });

            $(".justAddedStateVariablesInput").data("state", state);
            $(".justAddedStateVariablesInput").removeClass("justAddedStateVariablesInput");
        }
        $("#stateVariables").append("<img id='addStateVariable' style=\"width:12px;height:12px;\" src='../../sample-app/sampleapp-images/add.png'/>");
        $("#unitsOfInformation").append("<img id='addUnitOfInformation' style=\"width:12px;height:12px;\" src='../../sample-app/sampleapp-images/add.png'/>");

        $("#addStateVariable").click(function () {
            var obj = {};
            obj.clazz = "state variable";

            obj.state = {
                value: "",
                variable: ""
            };
            obj.bbox = {
                w: 69,
                h: 28
            };
            var param = {
                obj: obj,
                ele: ele,
                width: width
            };
          //todo  editorActions.manager._do(editorActions.AddStateAndInfoCommand(param));
        });

        $("#addUnitOfInformation").click(function () {
            var obj = {};
            obj.clazz = "unit of information";
            obj.label = {
                text: ""
            };
            obj.bbox = {
                w: 53,
                h: 18
            };
            var param = {
                obj: obj,
                ele: ele,
                width: width
            };
            //todo editorActions.manager._do(editorActions.AddStateAndInfoCommand(param));
        });
    }


</script>


</html>