<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="agentTester.css" type="text/css" rel="stylesheet">
    <title></title>
</head>
<body>
<script src="../../lib/js/socket.io.js"></script>
<script src="../../lib/js/jquery-1.8.2.js"></script>
<script src="agentAPI.js"></script>

<form>
    <input type="button" value="Delete Cookies" onclick=deleteAllCookies()>
</form>

<form id = "serverIpForm" >
    Agent name: <input type = "text" id = "agentName" name="agentName" value = "HAL">
    Server IP: <input type = "text" id = "serverIp" name="serverIp" >
    <!--<input type="button" value="Submit" onclick=createAgent()>-->
    <!--<script> createAgent()</script>-->
    <!--<script href="javascript:createAgent();"></script>-->

</form>

<div id = agentOperations>
<br>
<br>
    <button id = "updateModel" onclick = updateModel()>Model update request</button>
    <br>
    <br>
<form>
    Pos x : <input type = "number" id = "posX" name="posX" value = 200>
    Pos y : <input type = "number" id = "posY" name="posY" value = 200>
    Sbgnclass: <input type = "text" id = "sbgnclass" name="sbgnclass" value = "macromolecule">
    <input type="button" value="Add node" onclick=addNode()>
</form>
<br>
    <!-- Node operations-->
<form id = "nodeOperations">
    <!--Id : <input id = "delNodeId"  >-->
    <b>Node Id </b>: <select name="Id" id = "nodeId" >
    </select>

    <br><br>
    <input id = "sbgnlabel">
    <input type="button" value="Update node label" onclick=changeNodeAttribute("sbgnlabel")>


    <br><br>
    <input type="button" value="Delete node" onclick=deleteNode()>
    <br> <br>
    Pos x : <input type = "number" id = "newPosX">
    Pos y : <input type = "number" id = "newPosY">
    <input type="button" value="Move node" onclick=moveNode()>

    <br><br>

    <input id = "width" type = "number">
    <input type="button" value="Update node width" onclick=changeNodeAttribute("width")>


    <input id = "height" type = "number">
    <input type="button" value="Update node height" onclick=changeNodeAttribute("height")>


    <br><br>
    <input id = "borderColor" type = "color">
    <input type="button" value="Update border color" onclick=changeNodeAttribute("borderColor")>

    <br><br>
    <input id = "backgroundColor" type = "color">
    <input type="button" value="Update background color" onclick=changeNodeAttribute("backgroundColor")>

    <br><br>
    <input id = "borderWidth">
    <input type="button" value="Update border width" onclick=changeNodeAttribute("borderWidth")>


    <br><br>
    Update clone marker status <input id = "isCloneMarker" type="checkbox"  onclick=changeNodeAttribute("isCloneMarker")>

    <br><br>
    Update multimer status <input id = "isMultimer" type="checkbox"  onclick=changeNodeAttribute("isMultimer")>





    </form>
<br><br>

</div>


<div id = modelHistory>
<ul id = 'operationHistory'  as="container" onchange = scrollToBottom('operationHistory')><b>Commands<br></b></ul>
<ul id = 'chat' as="container" onchange = scrollToBottom('chat')><b>Chat Messages<br></b></ul>
<ul id = 'userList' as="container" onchange = scrollToBottom('userList')><b>Online Users<br></b></ul>
    <div id = "receivedImage"  onclick =openImage() ></div>
</div>


</body>


<script>

    var agent;


    window.onload = function (){
        createAgent();


        $('#agentName').change(function(){
            agent.changeName($('#agentName')[0].value);



        });

        $('#operationHistory').bind('contentchanged', function(){
            scrollToBottom('operationHistory');
        });

        $('#chat').bind('contentchanged', function(){
            scrollToBottom('chat');

        });

        $('#serverIp').change(function(){
            deleteCookie('docId'); //delete previous cookie

            //add the new cookie
            serverIp = $('#serverIp')[0].value;  //change cookie
            document.cookie = 'docId=' +  serverIp;  //add cookie docId

            createAgent();
        });

        $('#nodeId').change(function(){
            $('#newPosX')[0].value = preciseRound(agent.getNodeList()[$('#nodeId')[0].value].position.x, 3);
            $('#newPosY')[0].value = preciseRound(agent.getNodeList()[$('#nodeId')[0].value].position.y,3);
            $('#width')[0].value = preciseRound(agent.getNodeList()[$('#nodeId')[0].value].width,3);
            $('#height')[0].value = preciseRound(agent.getNodeList()[$('#nodeId')[0].value].height,3);
            $('#borderWidth')[0].value = agent.getNodeList()[$('#nodeId')[0].value].borderWidth;
            $('#borderColor')[0].value = agent.getNodeList()[$('#nodeId')[0].value].borderColor;
            $('#backgroundColor')[0].value = agent.getNodeList()[$('#nodeId')[0].value].backgroundColor;
            $('#sbgnlabel')[0].value = agent.getNodeList()[$('#nodeId')[0].value].sbgnlabel;


            if(agent.getNodeList()[$('#nodeId')[0].value].isCloneMarker)
                $('#isCloneMarker').attr('checked', 'checked');
            else
                $('#isCloneMarker').attr('checked', false);


            if(agent.getNodeList()[$('#nodeId')[0].value].isMultimer)
                $('#isMultimer').attr('checked', 'checked');
            else
                $('#isMultimer').attr('checked', false);
        });

    }



    function createAgent(){

        //don't open a new socket unless it is a new agent
        var agentId = getCookie('userId');

        if(agentId == null || agentId == ''){
            agentId = generateHash(32);
            document.cookie = 'userId=' +  agentId;  //add cookie docId
        }

        var serverIp = getCookie('docId')

        if(serverIp == null){
            serverIp = $('#serverIp')[0].value;
            document.cookie = 'docId=' +  serverIp;  //add cookie docId
        }
        else{
            $('#serverIp')[0].value = serverIp;
        }

        agent = new Agent($('#agentName')[0].value, agentId);
        var socket = agent.connectToServer(serverIp);



        socket.on('connect', function(){

            agent.getModel(function() {

                agent.updateNextAgentNodeId();
                agent.getOperationHistory(function(){

                    agent.getChatHistory(function(){
                        //agent.getUserList(function(){
                            //Write history
                                if(agent.opHistory != null){
                                    agent.opHistory.forEach(function(op){
                                        writeCommand(op);
                                    });
                                }

                                if(agent.chatHistory != null){
                                    for(var ind in agent.chatHistory){
                                        writeMessage(agent.chatHistory[ind]);

                                    };
                                }

                            fillNodeIds('nodeId');

                            //User list is updated in listen() method

                      //  });
                    });
                });
            });

            agent.listen(function(){

                socket.on('operation', function(data){
                    writeCommand(data);

                });
                socket.on('message', function(data){
                    writeMessage(data);
                });

                socket.on('userList', function(data){
                    writeUserList(data);
                });

                socket.on('imageFile', function(data){
                    writeImage(data);
                });

            });

        });
    }


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Agent requests and operations
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function updateModel(callback){
        agent.getModel(callback);

    };

    function addNode(){
        var x = $('#posX')[0].value;
        var y = $('#posY')[0].value;
        var sbgnclass = $('#sbgnclass')[0].value;
        var param = {x:x, y:y, sbgnclass:sbgnclass }

        agent.sendRequest("agentAddNodeRequest", {id: agent.getNextNodeId(), param:param});

    }


    function deleteNode(){
        agent.sendRequest("agentDeleteNodeRequest", {id: $('#nodeId')[0].value});
    }

    function moveNode(){
        var id = $('#nodeId')[0].value;
        var x = $('#newPosX')[0].value;
        var y = $('#newPosY')[0].value;



        var pos = {x:x, y:y};

        agent.sendRequest("agentMoveNodeRequest", {id: id, pos:pos});

    }

    function changeNodeAttribute(attDiv){


        var id = $('#nodeId')[0].value;
        var val = $('#' + attDiv)[0].value;

        if(attDiv == 'isCloneMarker')
            val = ($('#isCloneMarker').attr('checked') == 'checked');

        else if(attDiv == 'isMultimer')
            val = ($('#isMultimer').attr('checked') == 'checked');

        agent.sendRequest("agentChangeNodeAttributeRequest", {id:id, attStr:attDiv, attVal: val});
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///Page editing
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function fillNodeIds(divId){
        $('#'+divId).empty();
        var nodeList = agent.getNodeList();

        var nodeNameList = [];

        var i = 0;
        for( var node in nodeList){
            nodeNameList[i++] = node;

        };
        nodeNameList.sort();
        nodeNameList.forEach(function(nodeName){
            $('#'+divId).append("<option value =\"" + nodeName + "\">" + nodeName + "</option>") ;
        });
    }

    function writeCommand(op){
        var command = "<b>" + op.userName + " (" + formatTime(op) + "): " + "</b>"  +op.name +  " " +op.id +  " " +JSON.stringify(op.param);
        $('#operationHistory').append("<li>" + command+ "</li>");

        $('#operationHistory').trigger('contentchanged');

    }

    function writeMessage(msg){
        var htmlMessage = "<b>" + msg.userName + " (" + formatTime(msg) + "): "+ "</b>"  +msg.comment ;
        $('#chat').append("<li>" + htmlMessage+ "</li>");
        $('#chat').trigger('contentchanged');
    }


    function writeUserList(userList){
        $('#userList').empty();
        $('#userList').append("<b> Online Users");


        if(userList!=null){
            userList.forEach(function(usr){
                $('#userList').append("<li>" + usr.userName+ "</li>");
            });
        }
    }

    function writeImage(data){


        $('#receivedImage').append('<img src="' + data + '"/>');

    }



    function generateHash(len) {
        var symbols = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
        var hash = '';
        for (var i = 0; i < len; i++) {
            var symIndex = Math.floor(Math.random() * symbols.length);
            hash += symbols.charAt(symIndex);
        }
        return hash;
    }
    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
    }

    var deleteCookie = function(cname) {
        document.cookie = cname + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    };

    var deleteAllCookies = function(){
        deleteCookie('userId'); //delete previous cookie
        deleteCookie('docId'); //delete previous cookie

    };


    function formatTime(message){
        var hours, minutes, seconds, period, time;
        time = message && message.time;
        if (!time) {
            return;
        }
        time = new Date(time);
        hours = time.getHours();

        minutes = time.getMinutes();

        seconds = time.getSeconds();

        if (minutes < 10) {
            minutes = '0' + minutes;
        }
        if (seconds < 10) {
            seconds = '0' + seconds;
        }
        return hours + ':' + minutes + ':' + seconds;
    }

    function preciseRound(num, decimals) {
        if(decimals == null) decimals = 3;
        var t=Math.pow(10, decimals);
        return (Math.round((num * t) + (decimals>0?1:0)*(Math.sign(num) * (10 / Math.pow(100, decimals)))) / t).toFixed(decimals);
    }

    function scrollToBottom(docId){
        document.getElementById(docId).scrollTop = document.getElementById(docId).scrollHeight;

    }
    function openImage(){
        var largeImage = $('#receivedImage')[0];
        if( $('#receivedImage img')[0] !=null) {
            var url = $('#receivedImage img')[0].src;
            window.open(url, 'Image', 'width=largeImage.stylewidth,height=largeImage.style.height,resizable=1');
        }
    }

    function timeoutCallback(timeout,callback) {
        var called = false;
        if (typeof timeout === 'function') {
            callback = timeout;
            timeout = 30 * 1000;
        }

        var interval = setTimeout(function () {
            if (called)return;
            called = true;
            callback(new Error('callback timeout'));
        }, timeout);

        return function () {
            if (called)return;
            called = true;
            clearTimeout(interval);
            callback.apply(this, arguments);
        }
    }

</script>


</html>